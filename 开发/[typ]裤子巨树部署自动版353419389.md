
## 准备一台服务器，3个域名。 

### 一。教程开始：
1.安装系统CentOS 7.6
2.重置服务器密码
3.用SSH链接终端

### 二.安装宝塔
```
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```


### 2.安装环境
Nginx1.2
MySQL5.6
PHP7.2
phpMyAdmin 4.4
Redis
![image](imgs/353419389/img0.jpg)
### 三.安装Typecho
1.宝塔添加站点
2.网站根目录上传上面下载的源码：Typecho博客程序1.1.zip，然后解压。
3.创建数据库：数据库名，用户名，密码自定义（自己能记住就行）
4.设置伪静态:typecho
5.访问刚才创建的域名安装Typecho

### 四.安装RuleApi

首先，要确定服务器上安装了typecho，因为RuleApi本质上是typecho的扩展，所以连接的也是typecho的数据库。然后，安装一个redis，这个宝塔都是自带的，随便就安装了，不需要我多说。
最后，执行如下指令，安装screen

```
yum install screen
```


screen是一款进程保护程序，可以让你就算退出了终端，指令也会继续运行。安装过程会让你输入y什么的，就直接输入y再Enter确定，如果没有也没关系。

创建一个进程保护窗口，再进入opt文件夹

```
screen -S api
```

```
cd /opt
```


然后执行RuleApi一键安装脚本
主节点：
```
wget https://www.ruletree.club/api/ruleapi.sh && sh ruleapi.sh install
```


备用节点
```
wget https://www.ruletree.club/ruleapi.sh && sh ruleapi.sh install
```


安装完成后，将服务器/opt文件夹中的apiResult.php文件，剪切到typecho网站的根目录。

脚本还提供其它管理选项，分别是如下：

注意，项目启动之后，运行日志将输出到/opt目录下out.txt文件，如果启动后出现异常或者无法访问，可以打开这个文件查看具体的原因。/opt/application.properties为主要的配置文件，如果出现安装脚本配置错误，项目无法正常启动，就可以在这个文件进行修改。

启动RuleAPi

```
sh /opt/ruleapi.sh start
```


停止RuleAPi

```
sh /opt/ruleapi.sh stop
```


重启RuleAPi

```
sh /opt/ruleapi.sh restart
```


删除RuleAPi

```
sh /opt/ruleapi.sh uninstall
```


查看帮助信息

```
sh /opt/ruleapi.sh help
```


RuleApi更新

首先执行更新脚本

```
sh /opt/ruleapi.sh update
```


该脚本会下载当前服务器最新版jar和最新版的脚本文件，并将新版的新版配置文件application.properties下载至/opt/upfile，更新过程并不会重启接口，请自己对照/opt/upfile中的配置文件，查看是否有新增项，然后修改/opt/application.properties，比对无误后，执行重启脚本：

```
sh /opt/ruleapi.sh restart
```


有时候更新会失败，比如我的服务器被攻击，或者更新包下载不下来（服务器配置不高，穷）。这个时候，可以去这个文章，直接下载最新版本的压缩包，首先停止接口运行，把jar上传到opt，然后对比最新版的application.properties修改自己的配置文件，再执行脚本重启生效。

更多配置

因为脚本安装只是完成基础的安装，更多的设置需要编辑/opt/application.properties文件，里面就可以配置包括对象存储，数据库前缀，图片key，和其它更加详细的信息等，修改完成后，通过执行重启指令生效。

```
sh /opt/ruleapi.sh restart
```


如何访问RuleAPi？

宝塔里额外创建一个网站（二级域名，千万别和其它网站共用），网站类型为静态就好，然后找到伪静态设置，加入如下代码保存。

```
location ^~ / {
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-All
```

上述代码的用途是反向代理，并获取真实IP，且开始跨域。宝塔自带的反向代理功能比较复杂，所以省事的话，请采用上述的方法。其中127.0.0.1:8080就是你的内网接口地址，这里只需要改8080这个端口号（如果你定义了其它的话）

整个过程不要开启任何外网端口，切记！！！！

访问RuleApi主页面后，请点击初次安装执行，完成最终的安装。

本地图片上传

RuleAPi集成了oss和cos两种对象存储上传，如果都没有或者不想用的话，就需要配置本地图片上传。其实很简单，直接新增一个网站，目录设置为如下：

```
/opt/files/static
```


然后在可视化配置中心，设置访问图片的网址：

打包客户端
（1）.下载HBuilder X，这个百度都有自行下载，我这里就不放链接了。
（2）.打开HBuilder X，并将上面源码下载里面的KUHU.zip解压，拉到HBuilder X中。
（3）.https://ext.dcloud.net.cn/?cat1=1&type=HotList打开链接，下载插件scss/sass编译，less编译，下载的时候点上面绿色的使用HBuilder X导入插件。

项目设置

https://ext.dcloud.net.cn/plugin?id=6909打开链接导入到HBuilder X中

在导入完成项目后，请第一时间设置项目，主要就是设置项目的版本号，名称，还有启动图，图标等等，全部都在根目录的manifest.json。（注意：这里的版本号，名称，等都要与typecho根目录的apiResult.php里面的信息一样）这里面的一堆都可以自己摸索，反正玩不坏，玩坏了大不了重新下个项目继续玩。

然后设置utils文件目录下的api.js
var API_URL = 'RuleApi的网站域名'
var WEB_URL = 'typecho网站的域名'
var GroupUrl = 'QQ群链接';
var GithubUrl = 'Github链接';
其他的自己研究吧

修改完之后打包就完成了！
